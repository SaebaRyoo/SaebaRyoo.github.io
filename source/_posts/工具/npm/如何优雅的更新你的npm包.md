---
title: 如何优雅的更新你的npm包
date: 2025-03-15
categories:
  - 工具
tags:
  - Node
  - NPM
---

# 前言
在现代软件开发中，无论是前端应用、还是node服务 保持项目依赖的更新都是一项重要但具有挑战性的任务。过时的依赖可能会带来安全隐患、性能问题，以及与新特性的不兼容。然而，盲目地更新依赖也可能引入意外的破坏性变更，导致项目出现问题。

为了安全、高效地管理依赖更新，我们需要一个可靠的工具和系统的更新策略。本文将介绍 `npm-check-updates` 这个强大的工具，它不仅可以帮助我们检查和更新依赖，还能让我们对更新过程有更细粒度的控制。


在开始之前，让我们先了解一些重要的概念：

1. **语义化版本（Semantic Versioning）**：
   - 主版本号（Major）：做了不兼容的 API 修改
   - 次版本号（Minor）：做了向下兼容的功能性新增
   - 修订号（Patch）：做了向下兼容的问题修正

2. **版本号前缀的含义**：
   - `^`：允许次版本号和修订号更新（例如：^1.2.3 可以更新到 1.x.x）
   - `~`：只允许修订号更新（例如：~1.2.3 可以更新到 1.2.x）
   - `*`：允许所有更新（不推荐使用）


# 1. **安装npm-check-updates**

全局安装以使用 `npm-check-updates` 或更短的 `ncu`：

`npm install -g npm-check-updates`

或者使用`npx`安装

`npx npm-check-updates`

# 2. **使用**

## 2.1. **检查所有项目依赖项的最新版本**

**直接子在命令行输入**`ncu`，就会显示需要更新

```bash
[====================] 49/49 100%

 @elastic/elasticsearch             ^8.15.0  →   ^8.17.0
 @nestjs/cli                        ^10.0.0  →   ^11.0.4
 @nestjs/common                     ^10.0.0  →  ^11.0.10
 @nestjs/config                      ^3.2.2  →    ^4.0.0
 @nestjs/core                       ^10.0.0  →  ^11.0.10
 @nestjs/elasticsearch              ^10.0.1  →   ^11.0.0
...
```

## 2.2. **全部更新**

**这个命令会更新所有可以更新的包，慎用！**

`ncu -u`

## 2.3. **交互模式**

**使用以下命令基于交互模式来选择需要更新的包**

```bash
ncu --interactive
ncu -i
```

## 2.4. **按照指定的规则更新**

### 2.4.1. 只更新 `@nestjs/`开头的

#### 2.4.1.1. **检查可更新的 @nestjs/ 开头的依赖**

**在项目根目录下运行以下命令，查看 @nestjs/ 开头的依赖项有哪些可用的更新：**

```bash
ncu -f '@nestjs/*'
```

**此命令会列出 package.json 文件中所有 @nestjs/ 开头且可更新的依赖项，同时显示它们当前的版本和最新的版本。**

#### 2.4.1.2. **更新 package.json 文件**

**若你想把 package.json 文件里 @nestjs/ 开头的依赖项都更新到最新版本，可运行以下命令：**

```bash
ncu -u -f '@nestjs/*'
```

**该命令会修改 package.json 文件，将 @nestjs/ 开头的依赖项的版本号更新为最新的可用版本。**

#### 2.4.1.3. **安装更新后的依赖**

**package.json 文件更新完成后，运行以下命令来安装更新后的依赖项：**

```bash
npm install 
# 或者
yarn install
# 等等
```

## 2.5. **其他**

# 3. **最佳实践和注意事项**

## 3.1. **更新前的准备工作**

1. **备份项目**：
   - 确保项目代码已提交到版本控制系统
   - 创建一个新的分支进行依赖更新

2. **记录当前状态**：
   - 保存 package.json 和 package-lock.json 的副本
   - 记录项目的主要功能点，以便后续验证

## 3.2. **自动化更新策略**

1. **持续集成中的依赖更新**：
   - 配置自动化工具（如 Dependabot）定期检查依赖更新
   - 设置自动创建更新 PR，方便代码审查

2. **更新测试流程**：
   - 在更新后运行完整的测试套件
   - 进行关键功能的手动测试
   - 在开发环境中进行充分验证

## 3.3. **处理依赖冲突**

1. **版本冲突解决**：
   - 使用 `npm ls <package-name>` 查看依赖树
   - 检查 package-lock.json 中的依赖关系
   - 必要时使用 `npm dedupe` 优化依赖树

2. **降级策略**：
   - 如果更新后出现问题，使用 `npm install <package-name>@<version>` 回退到稳定版本
   - 在 package.json 中锁定关键依赖的版本

## 3.4. **更多资源**

**更多的命令和最佳实践请参考官方文档：**

[https://www.npmjs.com/package/npm-check-updates](https://www.npmjs.com/package/npm-check-updates)
